<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Demo gi√°m s√°t thi online (Camera + Micro + AI)</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 20px;
    }
    h1 {
      margin-top: 0;
      margin-bottom: 10px;
    }
    .layout {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 20px;
    }
    .card {
      background: #ffffff;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    }
    .video-box {
      position: relative;
      width: 100%;
      max-width: 520px;
      margin: 0 auto;
    }
    #video, #overlay {
      width: 100%;
      height: auto;
      border-radius: 10px;
      border: 1px solid #333;
      background: #000;
    }
    #overlay {
      position: absolute;
      left: 0;
      top: 0;
    }
    #status {
      margin-top: 8px;
      font-weight: bold;
      text-align: center;
    }
    .badge-ok { color: #15803d; font-weight: bold; }
    .badge-warn { color: #b45309; font-weight: bold; }
    .badge-alert { color: #b91c1c; font-weight: bold; }
    .badge-audio { color: #1d4ed8; font-weight: bold; }
    .note { font-size: 13px; color: #6b7280; margin-top: 6px; text-align: center; }

    .stat-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .stat-label { color: #4b5563; }
    .stat-value { font-weight: bold; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 6px;
      text-align: left;
    }
    th {
      background: #111827;
      color: #f9fafb;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:nth-child(even) td {
      background: #f9fafb;
    }
    .log-box {
      max-height: 260px;
      overflow: auto;
      margin-top: 10px;
      border-radius: 6px;
    }
    button {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      margin-top: 10px;
      background: #2563eb;
      color: #fff;
    }
    button:disabled {
      opacity: .6;
      cursor: not-allowed;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <h1>Demo gi√°m s√°t thi online (Camera + Micro + AI)</h1>
  <p>
    Ch∆∞∆°ng tr√¨nh n√†y c·∫ßn: <b>face-api.min.js</b> v√† th∆∞ m·ª•c <code>models/</code> ƒë·∫∑t c√πng th∆∞ m·ª•c v·ªõi file n√†y.
    Sau khi ch·∫°y, h√£y <b>cho ph√©p tr√¨nh duy·ªát s·ª≠ d·ª•ng camera & micro</b>.
  </p>

  <button id="btnStart">B·∫Øt ƒë·∫ßu gi√°m s√°t</button>

  <div class="layout" style="margin-top: 15px;">
    <!-- C·ªôt tr√°i: Camera + tr·∫°ng th√°i -->
    <div class="card">
      <h2>Camera gi√°m s√°t</h2>
      <div class="video-box">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="overlay"></canvas>
      </div>
      <div id="status">Ch∆∞a b·∫Øt ƒë·∫ßu. Nh·∫•n "B·∫Øt ƒë·∫ßu gi√°m s√°t".</div>
      <div class="note">
        <span class="badge-ok">1 khu√¥n m·∫∑t</span> ‚Äì b√¨nh th∆∞·ªùng,
        <span class="badge-warn">0 khu√¥n m·∫∑t</span> ‚Äì r·ªùi kh·ªèi khung h√¨nh,
        <span class="badge-alert">&gt;1 khu√¥n m·∫∑t</span> ‚Äì nghi c√≥ ng∆∞·ªùi h·ªó tr·ª£,
        <span class="badge-audio">üîä ti·∫øng n√≥i l·ªõn li√™n t·ª•c</span> ‚Äì nghi ƒëang trao ƒë·ªïi.
      </div>

      <hr style="margin: 15px 0;">

      <h3>Th·ªëng k√™</h3>
      <div class="stat-row">
        <span class="stat-label">ƒêi·ªÉm nghi v·∫•n:</span>
        <span class="stat-value" id="suspicionScore">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">S·ªë l·∫ßn kh√¥ng th·∫•y m·∫∑t &gt; 3s:</span>
        <span class="stat-value" id="noFaceCount">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">S·ªë l·∫ßn &gt; 1 khu√¥n m·∫∑t:</span>
        <span class="stat-value" id="multiFaceCount">0</span>
      </div>
      <div class="stat-row">
        <span class="stat-label">S·ªë l·∫ßn ti·∫øng n√≥i l·ªõn &gt; 4s:</span>
        <span class="stat-value" id="speechCount">0</span>
      </div>
    </div>

    <!-- C·ªôt ph·∫£i: B·∫£ng log -->
    <div class="card">
      <h2>Nh·∫≠t k√Ω gi√°m s√°t</h2>
      <div class="log-box">
        <table>
          <thead>
            <tr>
              <th>Th·ªùi gian</th>
              <th>S·ªë m·∫∑t</th>
              <th>S·ª± ki·ªán</th>
              <th>+ƒêi·ªÉm</th>
            </tr>
          </thead>
          <tbody id="logBody"></tbody>
        </table>
      </div>
      <p style="font-size: 12px; color:#6b7280; margin-top: 8px;">
        Trong h·ªá th·ªëng th·∫≠t, c√°c log n√†y s·∫Ω ƒë∆∞·ª£c g·ª≠i v·ªÅ server l∆∞u k√®m video/·∫£nh ƒë·ªÉ gi√°m th·ªã xem l·∫°i.
      </p>
    </div>
  </div>

  <!-- face-api.js LOCAL (t·∫£i file face-api.min.js v·ªÅ v√† ƒë·ªÉ c√πng th∆∞ m·ª•c) -->
  <script src="./face-api.min.js"></script>
  <script>
    const btnStart = document.getElementById('btnStart');
    const video = document.getElementById('video');
    const overlay = document.getElementById('overlay');
    const statusEl = document.getElementById('status');
    const logBody = document.getElementById('logBody');

    const suspicionScoreEl = document.getElementById('suspicionScore');
    const noFaceCountEl = document.getElementById('noFaceCount');
    const multiFaceCountEl = document.getElementById('multiFaceCount');
    const speechCountEl = document.getElementById('speechCount');

    const MODEL_URL = './models'; // th∆∞ m·ª•c models ch·ª©a weights

    let overlayCtx = null;
    let suspicionScore = 0;
    let noFaceCount = 0;
    let multiFaceCount = 0;
    let speechCount = 0;
    let lastFaceSeenTime = Date.now();

    // Audio monitor
    let audioContext = null;
    let analyser = null;
    let audioDataArray = null;
    let speakingStartTime = null;
    const SPEECH_THRESHOLD = 0.04;    // ng∆∞·ª°ng √¢m l∆∞·ª£ng
    const SPEECH_MIN_DURATION = 4000; // 4s ti·∫øng n√≥i li√™n t·ª•c

    function updateSuspicionUI() {
      suspicionScoreEl.textContent = suspicionScore;
      noFaceCountEl.textContent = noFaceCount;
      multiFaceCountEl.textContent = multiFaceCount;
      speechCountEl.textContent = speechCount;
    }

    function addLogRow(faceCount, eventText, deltaScore, type = 'video') {
      const tr = document.createElement('tr');
      const now = new Date();
      const timeStr = now.toTimeString().split(' ')[0];

      const tdTime = document.createElement('td');
      const tdCount = document.createElement('td');
      const tdEvent = document.createElement('td');
      const tdScore = document.createElement('td');

      tdTime.textContent = timeStr;
      tdCount.textContent = type === 'audio' ? '-' : faceCount;
      tdEvent.textContent = eventText;
      tdScore.textContent = deltaScore > 0 ? '+' + deltaScore : '';

      if (type === 'audio') {
        tdEvent.classList.add('badge-audio');
      } else {
        if (faceCount === 1) tdEvent.classList.add('badge-ok');
        else if (faceCount === 0) tdEvent.classList.add('badge-warn');
        else if (faceCount > 1) tdEvent.classList.add('badge-alert');
      }

      tr.appendChild(tdTime);
      tr.appendChild(tdCount);
      tr.appendChild(tdEvent);
      tr.appendChild(tdScore);

      logBody.prepend(tr);
    }

    async function initCameraAndAudio() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: true,
          audio: true
        });
        video.srcObject = stream;
        video.addEventListener('loadedmetadata', () => {
          overlay.width = video.videoWidth || overlay.width;
          overlay.height = video.videoHeight || overlay.height;
          overlayCtx = overlay.getContext('2d');
        });

        setupAudioMonitor(stream);
      } catch (err) {
        console.error('Kh√¥ng b·∫≠t ƒë∆∞·ª£c camera/micro:', err);
        statusEl.textContent = 'L·ªói: Kh√¥ng truy c·∫≠p ƒë∆∞·ª£c camera/micro.';
      }
    }

    function setupAudioMonitor(stream) {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(stream);
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        audioDataArray = new Uint8Array(analyser.fftSize);
        source.connect(analyser);
        monitorAudioLevel();
      } catch (e) {
        console.error('Kh√¥ng kh·ªüi t·∫°o ƒë∆∞·ª£c AudioContext:', e);
      }
    }

    function monitorAudioLevel() {
      if (!analyser || !audioDataArray) return;

      function check() {
        analyser.getByteTimeDomainData(audioDataArray);
        let sum = 0;
        for (let i = 0; i < audioDataArray.length; i++) {
          const v = (audioDataArray[i] - 128) / 128.0;
          sum += v * v;
        }
        const rms = Math.sqrt(sum / audioDataArray.length);
        const now = Date.now();

        if (rms > SPEECH_THRESHOLD) {
          if (!speakingStartTime) {
            speakingStartTime = now;
          } else {
            const duration = now - speakingStartTime;
            if (duration > SPEECH_MIN_DURATION) {
              speechCount += 1;
              suspicionScore += 1;
              addLogRow(0, 'Ti·∫øng n√≥i/√¢m thanh l·ªõn li√™n t·ª•c > 4s', 1, 'audio');
              updateSuspicionUI();
              speakingStartTime = null;
            }
          }
        } else {
          speakingStartTime = null;
        }

        requestAnimationFrame(check);
      }

      check();
    }

    async function loadModels() {
      statusEl.textContent = 'ƒêang t·∫£i m√¥ h√¨nh AI (models)...';
      await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
      await faceapi.nets.faceLandmark68TinyNet.loadFromUri(MODEL_URL);
      statusEl.textContent = 'ƒê√£ t·∫£i xong m√¥ h√¨nh. ƒêang b·∫≠t camera/micro...';
    }

    function startFaceMonitor() {
      const options = new faceapi.TinyFaceDetectorOptions({
        inputSize: 224,
        scoreThreshold: 0.5
      });

      statusEl.textContent = 'ƒêang gi√°m s√°t khu√¥n m·∫∑t & √¢m thanh...';

      setInterval(async () => {
        if (!overlayCtx) return;

        const detections = await faceapi
          .detectAllFaces(video, options)
          .withFaceLandmarks(true);

        overlayCtx.clearRect(0, 0, overlay.width, overlay.height);
        faceapi.draw.drawDetections(overlay, detections);
        faceapi.draw.drawFaceLandmarks(overlay, detections);

        const faceCount = detections.length;

        if (faceCount === 0) {
          statusEl.textContent = '‚ö† Kh√¥ng th·∫•y khu√¥n m·∫∑t.';
          const noFaceDuration = Date.now() - lastFaceSeenTime;
          if (noFaceDuration > 3000) {
            suspicionScore += 1;
            noFaceCount += 1;
            lastFaceSeenTime = Date.now();
            addLogRow(faceCount, 'Kh√¥ng th·∫•y khu√¥n m·∫∑t > 3s', 1, 'video');
            updateSuspicionUI();
          }
        } else if (faceCount === 1) {
          statusEl.textContent = '‚úÖ ƒêang th·∫•y 1 khu√¥n m·∫∑t.';
          lastFaceSeenTime = Date.now();
        } else {
          statusEl.textContent = '‚ö† Ph√°t hi·ªán ' + faceCount + ' khu√¥n m·∫∑t! Nghi c√≥ ng∆∞·ªùi h·ªó tr·ª£.';
          suspicionScore += 2;
          multiFaceCount += 1;
          addLogRow(faceCount, 'Ph√°t hi·ªán >1 khu√¥n m·∫∑t', 2, 'video');
          updateSuspicionUI();
        }
      }, 400);
    }

    async function startAll() {
      btnStart.disabled = true;
      await loadModels();
      await initCameraAndAudio();
      video.addEventListener('playing', () => {
        startFaceMonitor();
      });
    }

    btnStart.addEventListener('click', startAll);
  </script>
</body>
</html>
